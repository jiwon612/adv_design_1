#include <DHT.h>
#include <ESP8266WiFi.h>
#include <ESP8266WebServer.h>

// DHT11 센서 핀 설정
#define DHTPIN D3

// Wi-Fi 설정
const char* ssid = "hojun";
const char* password = "11111111";

// 웹 서버 객체 생성
ESP8266WebServer server(80);

// DHT11 객체 생성
DHT dht(DHTPIN, DHT11);

// 사람 수 세기 핀
const int infraredPin1 = D4; // digital 4번 핀에 연결된 적외선 센서
const int infraredPin2 = D5; // digital 5번 핀에 연결된 적외선 센서
const int ledPin = D10;
const int ledPin1 = D8;
const int ledPin2 = D9; // 8, 9, 10 핀에 연결된 LED 핀

int peopleCount = 0; // 사람의 수를 저장할 변수

void setup() {
  // 핀 모드 설정
  pinMode(infraredPin1, INPUT); // digital 4번 핀을 입력으로 설정
  pinMode(infraredPin2, INPUT); // digital 5번 핀을 입력으로 설정
  pinMode(ledPin, OUTPUT);
  pinMode(ledPin1, OUTPUT);
  pinMode(ledPin2, OUTPUT); // LED 핀을 출력으로 설정

  // 시리얼 통신 초기화
  Serial.begin(115200);

  // Wi-Fi 연결
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(1000);
    Serial.println("Connecting to WiFi...");
  }
  Serial.println("Connected to WiFi");
  Serial.print("IP address: ");
  Serial.println(WiFi.localIP());

  // 웹 서버 시작
  server.on("/", handleRoot);
  server.on("/peoplecount", handlePeoplecount);
  server.begin();
  Serial.println("Web server started");
}

void loop() {
  // 클라이언트 요청 처리
  server.handleClient();

  int sensorValue1 = digitalRead(infraredPin1); // digital 4번 핀의 센서 상태 읽기
  int sensorValue2 = digitalRead(infraredPin2); // digital 5번 핀의 센서 상태 읽기

  if (sensorValue1 == HIGH && sensorValue2 == LOW) {
    // digital 4번 핀을 통과한 후 digital 5번 핀을 통과한 경우
    peopleCount--; // 사람의 수 감소
    Serial.print("People count: ");
    Serial.println(peopleCount);
    delay(950); // 잠시 딜레이를 주어 중복 카운팅을 방지
  }
  else if (sensorValue1 == LOW && sensorValue2 == HIGH) {
    // digital 5번 핀을 통과한 후 digital 4번 핀을 통과한 경우
    digitalWrite(ledPin, HIGH);
    digitalWrite(ledPin1, HIGH);
    digitalWrite(ledPin2, HIGH); // LED 켜기
    delay(500); // 0.5초 동안 LED 유지
    digitalWrite(ledPin, LOW);
    digitalWrite(ledPin1, LOW);
    digitalWrite(ledPin2, LOW); // LED 끄기
  }
}

// 루트 경로 핸들러
void handleRoot() {
  String html = "<html><body>";
  html += "<h1>Welcome to People Count Web Server</h1>";
  html += "<p>Use /peoplecount to get the current people count.</p>";
  html += "</body></html>";
  server.send(200, "text/html", html);
}

// 사람 수 핸들러
void handlePeoplecount() {
  String countStr = String(peopleCount);
  server.send(200, "text/plain", countStr);
}
